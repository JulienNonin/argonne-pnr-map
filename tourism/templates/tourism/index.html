{% extends "tourism/base.html" %}

{% load l10n %}
{% load static %}
{% load leaflet_tags %}


{% block title %}Carte intéractive{% endblock title %}
{% block style %}
    <link rel="stylesheet" type="text/css" href="{% static 'tourism/style.css' %}">
    {% leaflet_js %}
    {% leaflet_css %}
{% endblock style %}

{% block content %}
<aside>
    {% comment %} {% include "tourism/sub/detail.html" %} {% endcomment %}
</aside>
        
{% leaflet_map "map" callback="map_init" %}
{% endblock content %}


{% block javascript %}
<script type="text/javascript">
    {% localize off %}
    // Define the default marker
    var icons = Array();
    var iconProps = {
        iconUrl: "{% static 'tourism/marker-default.png' %}",
        iconSize: [24, 28],
        iconAnchor: [12, 28],
        popupAnchor: [0, -28],
        tooltipAnchor: [0, -14],
        shadowUrl: "{% static 'tourism/marker-shadow.png' %}",
        shadowSize: [16, 30],
        shadowAnchor: [8, 26]}

    icons["default"] = L.icon(iconProps);


    function map_init(map, options) {
        {% for poi in poi_list %}
            var lon = "{{ poi.location.x }}";
            var lat = "{{ poi.location.y }}";
            marker = L.marker([lat, lon], {
                icon: icons['default'],
            });
            marker.on('click', function(e){
                var poi_id = $(this).attr('data-id');
                $.ajax({
                    type: 'GET',
                    url: "{% url 'tourism:poi_detail' %}",
                    data: {"poi_id": poi_id},
                    success: function (response) {
                        // map.setView(position);
                        console.log("Succès");
                        $("aside").html(response);
                    },
                    error: function(response) {
                        console.log("Échec de la requête AJAX (GET POI details)");
                        console.log(response);
                    }
                })
            });
            marker['data-id'] = "{{ poi.id }}";
            marker.addTo(map);
        {% endfor %}

        $.getJSON("{% static 'tourism/argonne.geojson' %}", function(json) {
            // console.log(L.GeoJSON.coordsToLatLngs(json.coordinates, 1));
            argonneBoundary = L.geoJSON(json, {
                style: {
                    color: "#95a98c",
                    weight: 1.3,
                    fillOpacity: 0,
                }                
            }).addTo(map);
            argonneBoundary.bringToBack();
        });
    }

    {% endlocalize %}
</script>
{% endblock javascript %}