{% extends "tourism/base.html" %}

{% load l10n %}
{% load static %}
{% load leaflet_tags %}


{% block title %}Carte intéractive{% endblock title %}
{% block style %}
    <link rel="stylesheet" type="text/css" href="{% static 'tourism/style.css' %}">
    {% leaflet_js %}
    {% leaflet_css %}
{% endblock style %}

{% block content %}
<div id="filter-shortcut">
    <ul>
        <li><img src={% static 'tourism/icons/calendar.png' %} draggable=false></li>
    </ul>
    <ul id="#layers-control" class="filters">
        {% for cat in category_list %}
        <li id="#clicon-{{ cat.tag }}" class="tooltip" onclick="changeLayersState(this)" title="{{ cat.name }}">
            {% with 'tourism/icons/'|add:cat.tag|add:'.png' as image_static %}
            <img src={% static image_static %} draggable=false>
            {% endwith %}
            <span class="tooltiptext tooltiptext-right">{{ cat.name }}</span>
        </li>
        {% endfor %}
    </ul>
    {% comment %} <img src={% static 'tourism/icons/icon-event.png' %}>
    <img src={% static 'tourism/icons/icon-tourism-info.png' %}>
    <img src={% static 'tourism/icons/icon-cultural-site.png' %}> {% endcomment %}
</div>

<div id="result-sidebar" class="sidebar sidebar-movable">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav('#result-sidebar')">×</a>
    <div class="content">
        <h2> Filtres </h2>
    </div>
</div>

<div id="main-sidebar" class="sidebar">
    {% comment %} <img id="loading-img" src={% static 'tourism/loader.gif' %} draggable=false}> {% endcomment %}
    <div class="content">
        <h1>Destination Argonne</h1>
    </div>
</div>

<div id="poi-sidebar" class="sidebar sidebar-movable">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav('#poi-sidebar');resetSelectedMarker()">×</a>
    <div class="content">
    {% comment %} {% include "tourism/sub/detail.html" %} {% endcomment %}
    </div>
</div>


{% leaflet_map "maCarte" callback="map_init" %}
{% endblock content %}


{% block javascript %}
<script type="text/javascript">
    {% localize off %}
    // Layers
    var map; // leaflet Map
    var mainLayer =  new L.LayerGroup();
    // var markersLayers = Object(); // store each layers: {tag : leaflet LayerGroup}
    var markersLoaded = Object(); // store each loaded markers: {poi_id : _leaflet_id}
    var selectedMarker = Object(); 
    var controlLayers; // leaflet Control.layers
    var categoriesSelected = Array();
    
    // Define the default marker
    var icons = Array();
    var iconProps = {
        iconUrl: "{% static 'tourism/markers/marker-default.svg' %}",
        iconSize: [24, 28],
        iconAnchor: [12, 28],
        popupAnchor: [0, -28],
        tooltipAnchor: [0, -14],
        shadowUrl: "{% static 'tourism/markers/marker-shadow.png' %}",
        shadowSize: [16, 30],
        shadowAnchor: [8, 26]}

    icons["default"] = L.icon(iconProps);

    function closeNav(id) {
        $(id).removeClass("active");
    }

    function showNav(id) {
        $(id).addClass("active");
    }

    function getIcon(tag) {
        if (icons[tag] == null) {
            var base_url = "{% static 'tourism/markers/marker-' %}";
            iconProps["iconUrl"] = base_url + tag + '.png';
            icons[tag] = L.icon(iconProps);
        }
        return icons[tag]
    }

    function loadMarkers() {
        // markersLayer.clearLayers();
        var bounds = map.getBounds();
        // $("#loading-img").show();
        $.ajax({
            type: 'GET',
            url: "{% url 'tourism:poi_load' %}",
            data: {
                "bounds": JSON.stringify(bounds),
                "categories": JSON.stringify(categoriesSelected)
            },
            success: function (response) {
                // map.setView(position);
                // response;
                // $("body").append(response);
                $("#main-sidebar .content").html(response);
            },
            complete: function() {
                // $("#loading-img").hide();
            },
            error: function(response) {
                console.log("Échec de la requête AJAX (loadMarkers)");
                console.log(response);
            }
        })
    }

    function changeLayersState(iconCategory) {
        // console.log(iconCategory);
        tag = iconCategory.id.slice(8); // remove '#clicon-" from #clicon-tag-name
        if (categoriesSelected.includes(tag)) {
            iconCategory.classList.remove("checked");
            // map.removeLayer(markersLayers[tag]);
            const index = categoriesSelected.indexOf(tag);
            if (index > -1) {
                categoriesSelected.splice(index, 1)
            }
        } else {
            // map.addLayer(markersLayers[tag]);
            iconCategory.classList.add("checked");
            categoriesSelected.push(tag);
        }
        loadMarkers()
    }

    function createLayersByCategory() {
        // layerSwitcher = $("#layers-control");

        {% for cat in category_list %}
            // Create new LayerGroup
            markersLayers["{{ cat.tag }}"] = new L.LayerGroup();
            
            // Create inputs to remove/add layerGroups (cf. changeLayersState)
            /*label = $("<label>", {for: "{{ cat.tag }}"});
            labelDiv = $("<div>").appendTo(label);
            $("<input>", {
                type:"checkbox",
                id: "{{ cat.tag }}",
                name:"category-layer",
                checked: "{{ cat.tag }}" == "event",
                onchange:"changeLayersState(this)"}).appendTo(labelDiv);
            $("<span>").html("{{ cat.name }}").appendTo(labelDiv);
            label.appendTo(layerSwitcher)*/

        {% endfor %}

        // Init: display default layers
        // changeLayersState($("#clicon-event"));
        /*inputs = $("#layers-control input");
        for (i = 0; i < inputs.length; i++) {
            changeLayersState(inputs[i]);
        }*/
    }

    function displayPoiDetails(poi_id){
        $.ajax({
            type: 'GET',
            url: "{% url 'tourism:poi_detail' %}",
            data: {"poi_id": poi_id},
            success: function (response) {
                // map.setView(position);
                $("#poi-sidebar .content").html(response);
                showNav("#poi-sidebar")
            },
            error: function(response) {
                console.log("Échec de la requête AJAX (GET POI details)");
                console.log(response);
            }
        })
    }
    function emphasizeMarker(my_icon) {     
        my_icon.style.width = "30px";
        my_icon.style.height = "35px";
        my_icon.style.marginLeft = '-15px'
        my_icon.style.marginTop = '-35px'
        selectedMarker["z-index"] = my_icon.style.zIndex;
        my_icon.style.zIndex = 5000;
        selectedMarker["icon"] = my_icon;
    }

    function resetSelectedMarker(){
        if (Object.entries(selectedMarker).length) {
            // Reset the previously selected icon
            selectedMarker["icon"].style.width = "24px";
            selectedMarker["icon"].style.height = "28px";
            selectedMarker["icon"].style.marginLeft = "-12px";
            selectedMarker["icon"].style.marginTop = "-28px";
            selectedMarker["icon"].style.zIndex = selectedMarker["z-index"];
        }
    }

    function onMarkerClick(e) {
        // 1. Emphasize the corresponding icon

        var my_icon = $(this)[0]._icon;
        resetSelectedMarker();
        emphasizeMarker(my_icon);

        // 2. Get details from the selected POI        
        var poi_id = $(this).attr('data-id');
        displayPoiDetails(poi_id);
    }

    function onResultHover(poi_id) {
        emphasizeMarker(mainLayer.getLayer(markersLoaded[poi_id])._icon);
    }

    function onResultClick(elmt, poi_id) {
        console.log($(elmt));
        console.log($(elmt).attr("onmouseleave", "console.log('LEAVE')"));
        var my_icon = mainLayer.getLayer(markersLoaded[poi_id])._icon;
        displayPoiDetails(poi_id);
        setTimeout(function(){
            console.log($(elmt).attr("onmouseleave", "resetSelectedMarker()"));
        }, 700);
    }

    function map_init(mmap, options) {
        map = mmap; // store the object in a variable
        controlLayers = map.layerscontrol;

        // Display initial markers
        // createLayersByCategory();
        // $("#loading-img").hide()
        map.addLayer(mainLayer);
        loadMarkers();
			
		/*map.on('drag', function(e) {
            markersLayer.clearLayers();
		});*/

        /*$(window).on('resize', function() {
            console.log("resize");
            loadMarkers();
        });*/
			
		map.on('dragend', function(e) {
		    // markersLayer.clearLayers();
		    loadMarkers();
		});

        map.on('zoomend', function() {
            loadMarkers();
        });

        map.on('click', function() {
            closeNav('#poi-sidebar');
            resetSelectedMarker();
        });

        // Display Argonne's contour
        $.getJSON("{% static 'tourism/argonne.geojson' %}", function(json) {
            // console.log(L.GeoJSON.coordsToLatLngs(json.coordinates, 1));
            argonneBoundary = L.geoJSON(json, {
                style: {
                    color: "#95a98c",
                    weight: 1.3,
                    fillOpacity: 0,
                    className: "argonne-geojson",
                }                
            }).addTo(map);
            argonneBoundary.bringToBack();
        });
    }

    {% endlocalize %}
</script>
<script src="{% static 'tourism/front.js' %}"></script>
{% endblock javascript %}