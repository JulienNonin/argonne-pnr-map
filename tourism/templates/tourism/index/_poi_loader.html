{% load l10n %}

<h1> {{ poi_list | length }} RÃ©sultat(s) </h1>
<div class="results">
{% for poi in poi_list %}
    <article class="card">
        <header class="thumb">
        {% if poi.mainrepresentation %}
            {% comment %} <header class="thumb" style="background-image: url('{{ poi.mainrepresentation.picture.url }}')"></header> {% endcomment %}
            <img src="{{ poi.mainrepresentation.picture.url }}" alt="{{ poi.mainrepresentation.picture.title }}" draggable="false">
        {% else %}
            
        {% endif %}
        </header>
        <div class="body">
            <h2 class="title" onclick="displayPoiDetails({{poi.id}})"> {{ poi.name }}</h2>
            <div class="subtitle">
                <span class="city">{{ poi.commune.name }}</span>
            </div>
            <p>{{ poi.description }}</p>
            <div class="rect"></div>
            <div class="rect_white"></div>
        </div>
    </article>
{% endfor %}
</div>

<script>
{% localize off %}
    console.log("{{ categories }}")
    // console.log("{{ poi_list | length}} POIs loaded");
    // console.log("markersLoaded Before", markersLoaded);
    // markersLayer.clearLayers();
    var markersLoadedNew = Object(); // key: id -> value: leaflet_id
    // Add all new markers
    {% for poi in poi_list %}
        var poi_id = "{{ poi.id }}";
        if (markersLoaded[poi_id] == null) { // new marker to display
            var lon = "{{ poi.location.x }}";
            var lat = "{{ poi.location.y }}";
            var marker = L.marker([lat, lon], {
                icon: getIcon("{{ poi.category.icon }}"),
            });
            marker.on('click', onMarkerClick);
            marker['data-id'] = poi_id;
            markersLayers["{{ poi.category.tag }}"].addLayer(marker);
            markersLoadedNew[poi_id] = marker._leaflet_id;
        } else {
            markersLoadedNew[poi_id] = markersLoaded[poi_id]
        }
    {% endfor %}

    // console.log("markersLoaded New", markersLoadedNew);


    // Remove unwanted markers (not in leagletIdToKeep)
    leafletIdToKeep = Object.values(markersLoadedNew);
    // console.log("leafletIdToKeep", leafletIdToKeep);

    Object.values(markersLayers).forEach((layerGroup) => {
        layerGroup.eachLayer(function (layer) {
            if (!(leafletIdToKeep.includes(layer._leaflet_id))) {
                layerGroup.removeLayer(layer);
            }
        });
    });
    markersLoaded = markersLoadedNew;

{% endlocalize %}
</script>